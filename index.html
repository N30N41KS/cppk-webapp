<script>
const tg = window.Telegram.WebApp;
tg.expand();

// ==========================
//   ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
// ==========================
let currentCategory = "mcd";
let selectedStation = "";
let debounceTimer = null;

const searchInput = document.getElementById('station-search');
const dropdown = document.getElementById('custom-stations-list');
const submitBtn = document.getElementById('submit-btn');

// ==========================
//   ПОСТОЯННЫЕ ДАННЫЕ
// ==========================
const lineColors = {
    "1": "#EF161E", "2": "#2D82BC", "3": "#0078BF", "4": "#00BFFF",
    "5": "#8D552D", "6": "#ED9121", "7": "#800080", "8": "#FFD702",
    "8A": "#FFD702", "9": "#999999", "10": "#22B14C", "11": "#A1B3AD",
    "12": "#9999FF", "14": "#F6F032", "15": "#43404A",
    "D1": "#9E5B0C", "D2": "#E74280", "D3": "#9E5B0C", "D4": "#40826B"
};

// ==========================
//   ПОСТРОЕНИЕ СПИСКА СТАНЦИЙ
// ==========================
let stations = [];

function buildStations() {
    stations = [];

    for (const [line, list] of Object.entries(data)) {
        const isMCD = line.startsWith("D");
        if ((currentCategory === "mcd" && isMCD) || (currentCategory === "metro" && !isMCD)) {
            list.forEach(name => {
                stations.push({
                    name: `${name} ${isMCD ? "· Линия " : ""}${line}`,
                    icon: `img/${line}.svg`,
                    lineId: line
                });
            });
        }
    }
}

buildStations();

// ==========================
//   РЕНДЕР DROPDOWN
// ==========================
function renderDropdown(value) {
    dropdown.innerHTML = "";

    if (!value.trim()) {
        dropdown.classList.remove("active");
        return;
    }

    const filtered = stations
        .filter(s => s.name.toLowerCase().includes(value.toLowerCase()))
        .slice(0, 15);

    if (filtered.length === 0) {
        dropdown.classList.remove("active");
        return;
    }

    filtered.forEach(st => {
        const item = document.createElement("div");
        item.className = "dropdown-item";
        item.innerHTML = `
            <div class="icon-box">
                <img src="${st.icon}" onerror="this.src='img/metro.svg'">
            </div>
            <div class="name">${st.name}</div>
        `;

        item.onclick = () => {
            selectedStation = st.name;
            searchInput.value = st.name;
            dropdown.classList.remove("active");

            const color = lineColors[st.lineId] || "#005AAB";
            document.documentElement.style.setProperty("--primary-color", color);

            tg.HapticFeedback.impactOccurred("light");
        };

        dropdown.appendChild(item);
    });

    dropdown.classList.add("active");
}

// ==========================
//   DEBOUNCE ПОИСКА
// ==========================
searchInput.addEventListener("input", e => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        renderDropdown(e.target.value);
    }, 120);
});

// Закрытие dropdown при клике вне
document.addEventListener("click", e => {
    if (!dropdown.contains(e.target) && e.target !== searchInput) {
        dropdown.classList.remove("active");
    }
});

// ==========================
//   ПЕРЕКЛЮЧЕНИЕ ВКЛАДОК
// ==========================
window.switchCategory = function(cat) {
    if (currentCategory === cat) return;

    currentCategory = cat;
    selectedStation = "";
    searchInput.value = "";

    document.getElementById("tabs-container").classList.toggle("metro-active", cat === "metro");
    document.getElementById("tab-mcd").classList.toggle("active", cat === "mcd");
    document.getElementById("tab-metro").classList.toggle("active", cat === "metro");

    document.documentElement.style.setProperty("--primary-color", "#005AAB");

    buildStations();
    dropdown.classList.remove("active");

    tg.HapticFeedback.impactOccurred("light");
};

// ==========================
//   ОТПРАВКА ДАННЫХ
// ==========================
submitBtn.onclick = () => {
    const desc = document.getElementById("description").value.trim();

    if (!desc || !selectedStation) {
        tg.HapticFeedback.notificationOccurred("error");
        tg.showAlert("Выберите станцию и опишите проблему");
        return;
    }

    // Блокируем повторное нажатие
    submitBtn.disabled = true;

    submitBtn.classList.add("train-depart");
    tg.HapticFeedback.impactOccurred("heavy");

    // Анимация вибрации поезда
    const delays = [400, 350, 300, 250, 200, 150, 120, 100, 80, 60, 50, 40, 30, 20, 10, 0];
    let step = 0;

    function clack() {
        if (step < delays.length) {
            tg.HapticFeedback.impactOccurred(step % 2 === 0 ? "rigid" : "medium");
            setTimeout(clack, delays[step]);
            step++;
        }
    }

    setTimeout(clack, 350);

    setTimeout(() => {
        tg.HapticFeedback.notificationOccurred("success");
        tg.sendData(JSON.stringify({
            station: selectedStation,
            description: desc,
            category: currentCategory
        }));
        tg.close();
    }, 3800);
};
</script>
